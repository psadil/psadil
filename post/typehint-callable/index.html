<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.2.0 for Hugo"><meta name=author content="Patrick Sadil"><meta name=description content="Recently, I encountered a python function that I didn&rsquo;t want to modify, but whose output I wanted cached. Providing typehints for this seemed a bit complicated, so I&rsquo;m posting this gist as a reminder. The main trick involves extensions from PEP 612.
In words, the decorator will take some function f that takes parameters P and produces a str. I want to be able to call f and additionally provide a filename that will point to a file in which the string will be written."><link rel=alternate hreflang=en-us href=https://psadil.github.io/psadil/post/typehint-callable/><link rel=preconnect href=https://fonts.gstatic.com crossorigin><meta name=theme-color content="#1565c0"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/atom-one-dark.min.css crossorigin=anonymous title=hl-light media=print onload="this.media='all'"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/atom-one-dark.min.css crossorigin=anonymous title=hl-dark media=print onload="this.media='all'" disabled><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload="this.media='all'"><link rel=stylesheet href=/psadil/css/wowchemy.8bc78ecea639e288ab749bc0faab617c.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-SP0TP763NP"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}function trackOutboundLink(a,b){gtag('event','click',{event_category:'outbound',event_label:a,transport_type:'beacon',event_callback:function(){b!=='_blank'&&(document.location=a)}}),console.debug("Outbound link clicked: "+a)}function onClickCallback(a){if(a.target.tagName!=='A'||a.target.host===window.location.host)return;trackOutboundLink(a.target,a.target.getAttribute('target'))}gtag('js',new Date),gtag('config','G-SP0TP763NP',{}),gtag('set',{cookie_flags:'SameSite=None;Secure'}),document.addEventListener('click',onClickCallback,!1)</script><link rel=manifest href=/psadil/index.webmanifest><link rel=icon type=image/png href=/psadil/media/icon_hu3896c2ce465988ba1fc8077f9a6388c6_268630_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/psadil/media/icon_hu3896c2ce465988ba1fc8077f9a6388c6_268630_180x180_fill_lanczos_center_2.png><link rel=canonical href=https://psadil.github.io/psadil/post/typehint-callable/><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@psadil"><meta property="twitter:creator" content="@psadil"><meta property="og:site_name" content="psadil"><meta property="og:url" content="https://psadil.github.io/psadil/post/typehint-callable/"><meta property="og:title" content="Hinting Cache Decorator Types | psadil"><meta property="og:description" content="Recently, I encountered a python function that I didn&rsquo;t want to modify, but whose output I wanted cached. Providing typehints for this seemed a bit complicated, so I&rsquo;m posting this gist as a reminder. The main trick involves extensions from PEP 612.
In words, the decorator will take some function f that takes parameters P and produces a str. I want to be able to call f and additionally provide a filename that will point to a file in which the string will be written."><meta property="og:image" content="https://psadil.github.io/psadil/post/typehint-callable/featured.png"><meta property="twitter:image" content="https://psadil.github.io/psadil/post/typehint-callable/featured.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2022-10-23T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-13T12:58:05-04:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://psadil.github.io/psadil/post/typehint-callable/"},"headline":"Hinting Cache Decorator Types","image":["https://psadil.github.io/psadil/post/typehint-callable/featured.png"],"datePublished":"2022-10-23T00:00:00Z","dateModified":"2023-08-13T12:58:05-04:00","author":{"@type":"Person","name":"Patrick Sadil"},"publisher":{"@type":"Organization","name":"psadil","logo":{"@type":"ImageObject","url":"https://psadil.github.io/psadil/media/icon_hu3896c2ce465988ba1fc8077f9a6388c6_268630_192x192_fill_lanczos_center_2.png"}},"description":"Recently, I encountered a python function that I didn\u0026rsquo;t want to modify, but whose output I wanted cached. Providing typehints for this seemed a bit complicated, so I\u0026rsquo;m posting this gist as a reminder. The main trick involves extensions from PEP 612.\nIn words, the decorator will take some function f that takes parameters P and produces a str. I want to be able to call f and additionally provide a filename that will point to a file in which the string will be written."}</script><title>Hinting Cache Decorator Types | psadil</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=14a965c58598d6d9cf251f827dbbb078><script src=/psadil/js/wowchemy-init.min.b8153d4570dcbb34350a2a846dba8c03.js></script><div class=page-header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/psadil/>psadil</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/psadil/>psadil</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/psadil/publication><span>Publications</span></a></li><li class=nav-item><a class="nav-link active" href=/psadil/post><span>Blog</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-moon" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span></a>
<a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span></a>
<a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></div><div class=page-body><article class=article><div class="article-container pt-3"><h1>Hinting Cache Decorator Types</h1><div class=article-metadata><span class=article-date>Last updated on
Aug 13, 2023</span>
<span class=middot-divider></span><span class=article-reading-time>2 min read</span>
<span class=middot-divider></span><span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/psadil/category/gist/>gist</a></span></div></div><div class="article-header article-container featured-image-wrapper mt-4 mb-4" style=max-width:720px;max-height:540px><div style=position:relative><img src=/psadil/post/typehint-callable/featured_hu81669b96a31c72cf4aed9342c27cc4b3_1430553_720x0_resize_lanczos_2.png alt class=featured-image></div></div><div class=article-container><div class=article-style><p>Recently, I encountered a python function that I didn&rsquo;t want to modify, but whose output I wanted cached. Providing typehints for this seemed a bit complicated, so I&rsquo;m posting this gist as a reminder. The main trick involves extensions from <a href=https://peps.python.org/pep-0612/ target=_blank rel=noopener>PEP 612</a>.</p><p>In words, the decorator will take some function <code>f</code> that takes parameters <code>P</code> and produces a <code>str</code>. I want to be able to call <code>f</code> and additionally provide a filename that will point to a file in which the string will be written. The cache will be super basic, checking just for the existence of the file and skipping <code>f</code> if that file exists.</p><p>In code, that looks like the following</p><pre><code class=language-python>from pathlib import Path
import typing
P = typing.ParamSpec(&quot;P&quot;)

def cache_str(f: typing.Callable[P, str]) -&gt; typing.Callable[typing.Concatenate[Path, P], str]:
    def wrapper(_filename: Path, *args: P.args, **kwargs: P.kwargs) -&gt; str:
        if _filename.exists():
            print(f&quot;Found cached result {_filename}. Skipping!&quot;)
            i = _filename.read_text()
        else:
            # run!
            i = f(*args, **kwargs)
            _filename.touch()
            _filename.write_text(i)
        return i
    return wrapper
</code></pre><p>And then the decorator could be used like</p><pre><code class=language-python>@cache_str
def get_str(msg: str) -&gt; str:
    print(&quot;This function takes so long to run--I hope that I don't need to run it twice&quot;)
    return msg
</code></pre><pre><code class=language-python>import tempfile

msg = &quot;cached message&quot;

with tempfile.TemporaryDirectory() as tmpdir:
    tmp_path = Path(tmpdir) / &quot;cache.txt&quot;
    get_str(tmp_path, msg=msg)
    print(&quot;trying to read message from cache...&quot;)
    print(f&quot;{tmp_path.read_text()=}&quot;)
    get_str(tmp_path, msg=msg)
</code></pre><pre><code>This function takes so long to run--I hope that I don't need to run it twice
trying to read message from cache...
tmp_path.read_text()='cached message'
Found cached result /tmp/tmpp44byo4s/cache.txt. Skipping!
</code></pre><p>This is neat, but although my editor recognizes that the decorated function can accept a path as the first argument, that first argument could not be named. This appears to have been an explicit choice in PEP 612, made to avoid potential clashes with keyword arguments from the decorated function.</p></div><p class=edit-page><a href=https://github.com/psadil/psadil/blob/main/content/post/2022-10-19-typehint-cache-decorator/index.en.md>View Page Source</a></p><div class=article-tags><a class="badge badge-light" href=/psadil/tag/python/>python</a></div><div class=share-box aria-hidden=true><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https://psadil.github.io/psadil/post/typehint-callable/&text=Hinting%20Cache%20Decorator%20Types" target=_blank rel=noopener class=share-btn-twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https://psadil.github.io/psadil/post/typehint-callable/&t=Hinting%20Cache%20Decorator%20Types" target=_blank rel=noopener class=share-btn-facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Hinting%20Cache%20Decorator%20Types&body=https://psadil.github.io/psadil/post/typehint-callable/" target=_blank rel=noopener class=share-btn-email><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https://psadil.github.io/psadil/post/typehint-callable/&title=Hinting%20Cache%20Decorator%20Types" target=_blank rel=noopener class=share-btn-linkedin><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=Hinting%20Cache%20Decorator%20Types%20https://psadil.github.io/psadil/post/typehint-callable/" target=_blank rel=noopener class=share-btn-whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https://psadil.github.io/psadil/post/typehint-callable/&title=Hinting%20Cache%20Decorator%20Types" target=_blank rel=noopener class=share-btn-weibo><i class="fab fa-weibo"></i></a></li></ul></div><div class="media author-card content-widget-hr"><a href=https://psadil.github.io/psadil/><img class="avatar mr-3 avatar-circle" src="https://s.gravatar.com/avatar/6e7d3d145f872ee736e7714ceb8265c6?s=200" alt="Patrick Sadil"></a><div class=media-body><h5 class=card-title><a href=https://psadil.github.io/psadil/>Patrick Sadil</a></h5><h6 class=card-subtitle>Post-Doctoral Researcher</h6><ul class=network-icon aria-hidden=true><li><a href=mailto:psadil1@jh.edu><i class="fas fa-envelope"></i></a></li><li><a href=https://psadil.github.io/cv/cv.pdf target=_blank rel=noopener><i class="ai ai-cv"></i></a></li><li><a href=//orcid.org/0000-0003-4141-1343><i class="ai ai-orcid"></i></a></li><li><a href="https://scholar.google.co.uk/citations?user=HhPeElcAAAAJ" target=_blank rel=noopener><i class="ai ai-google-scholar"></i></a></li><li><a href=https://github.com/psadil target=_blank rel=noopener><i class="fab fa-github"></i></a></li></ul></div></div></div></article></div><div class=page-footer><div class=container><footer class=site-footer><p class=powered-by><a href=/psadil/privacy/>Privacy Policy</a>
&#183;
<a href=/psadil/terms/>Terms</a></p><p class=powered-by>© 2021 Patrick Sadil</p><p class=powered-by>Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target=_blank rel=noopener>Wowchemy</a> — the free, <a href=https://github.com/wowchemy/wowchemy-hugo-modules target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/matlab.min.js></script><script src=/psadil/js/bootstrap.bundle.min.6aed84840afc03ab4d5750157f69c120.js></script><script src=/psadil/en/js/wowchemy.min.c7dbcd0a03997d954a216caf59fc7681.js></script></body></html>